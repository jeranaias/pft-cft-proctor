/**
 * PDF Generator for PFT/CFT Worksheets
 * Uses jsPDF library (loaded via CDN)
 * Format based on NAVMC 11622
 */

const PDFGenerator = {
  /**
   * Generate PDF for a single Marine
   */
  generateSinglePDF(marine, testType, unit, date) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const isPFT = testType === 'pft';
    const title = isPFT ? 'PFT PERFORMANCE WORKSHEET' : 'CFT PERFORMANCE WORKSHEET';

    // Header
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title, 105, 20, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('(Unofficial - For Reference Only)', 105, 27, { align: 'center' });

    // Unit and Date
    doc.setFontSize(11);
    doc.text(`Unit: ${unit || 'N/A'}`, 20, 40);
    doc.text(`Date: ${this.formatDate(date)}`, 140, 40);

    // Marine Information Box
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.rect(15, 50, 180, 35);

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('MARINE INFORMATION', 20, 58);

    doc.setFont('helvetica', 'normal');
    doc.text(`Name: ${marine.name || 'N/A'}`, 20, 66);
    doc.text(`Rank: ${marine.rank || 'N/A'}`, 100, 66);
    doc.text(`EDIPI: ${marine.edipi || 'N/A'}`, 150, 66);

    doc.text(`DOB: ${marine.dob || 'N/A'}`, 20, 74);
    doc.text(`Age: ${marine.age || 'N/A'}`, 70, 74);
    doc.text(`Gender: ${marine.gender === 'male' ? 'Male' : 'Female'}`, 100, 74);

    if (marine.height) {
      doc.text(`Height: ${marine.height}"`, 150, 74);
    }
    if (marine.weight) {
      doc.text(`Weight: ${marine.weight} lbs`, 20, 82);
    }

    // Event Scores Table
    doc.rect(15, 95, 180, 10);
    doc.setFont('helvetica', 'bold');
    doc.text('EVENT', 50, 102, { align: 'center' });
    doc.text('RAW SCORE', 110, 102, { align: 'center' });
    doc.text('POINTS', 165, 102, { align: 'center' });

    doc.setFont('helvetica', 'normal');
    let yPos = 105;

    if (isPFT) {
      // PFT Events
      const events = [
        { name: marine.results.upperBody.event, raw: marine.rawScores.upperBody, pts: marine.results.upperBody.score },
        { name: 'Plank', raw: marine.rawScores.plank, pts: marine.results.core.score },
        { name: marine.results.cardio.event, raw: marine.rawScores.cardio, pts: marine.results.cardio.score }
      ];

      events.forEach(event => {
        yPos += 10;
        doc.rect(15, yPos - 5, 180, 10);
        doc.text(event.name, 50, yPos + 2, { align: 'center' });
        doc.text(String(event.raw), 110, yPos + 2, { align: 'center' });
        doc.text(String(event.pts), 165, yPos + 2, { align: 'center' });
      });
    } else {
      // CFT Events
      const events = [
        { name: 'Movement to Contact', raw: marine.rawScores.mtc, pts: marine.results.mtc.score },
        { name: 'Ammunition Lift', raw: marine.rawScores.ammoLift, pts: marine.results.al.score },
        { name: 'Maneuver Under Fire', raw: marine.rawScores.manuf, pts: marine.results.manuf.score }
      ];

      events.forEach(event => {
        yPos += 10;
        doc.rect(15, yPos - 5, 180, 10);
        doc.text(event.name, 50, yPos + 2, { align: 'center' });
        doc.text(String(event.raw), 110, yPos + 2, { align: 'center' });
        doc.text(String(event.pts), 165, yPos + 2, { align: 'center' });
      });
    }

    // Total Score Box
    yPos += 20;
    doc.setFillColor(240, 240, 240);
    doc.rect(15, yPos, 180, 25, 'FD');

    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(`TOTAL SCORE: ${marine.results.total}`, 60, yPos + 12);

    doc.setFontSize(12);
    doc.text(`Classification: ${marine.results.classification}`, 130, yPos + 12);
    doc.text(`Grade: ${marine.results.grade}`, 130, yPos + 20);

    // Signature Lines
    yPos += 40;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    doc.line(20, yPos, 90, yPos);
    doc.text('Marine Signature', 55, yPos + 5, { align: 'center' });

    doc.line(110, yPos, 180, yPos);
    doc.text('Monitor Signature', 145, yPos + 5, { align: 'center' });

    yPos += 15;
    doc.line(20, yPos, 90, yPos);
    doc.text('Date', 55, yPos + 5, { align: 'center' });

    doc.line(110, yPos, 180, yPos);
    doc.text('Date', 145, yPos + 5, { align: 'center' });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(128);
    doc.text('Generated by PFT/CFT Proctor App - USMC Tools Suite', 105, 280, { align: 'center' });
    doc.text('https://jeranaias.github.io/pft-cft-proctor', 105, 285, { align: 'center' });

    return doc;
  },

  /**
   * Generate PDF for multiple Marines (session report)
   */
  generateSessionPDF(session) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const isPFT = session.testType === 'pft';
    const title = isPFT ? 'PFT SESSION REPORT' : 'CFT SESSION REPORT';

    // Header
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title, 105, 20, { align: 'center' });

    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`Unit: ${session.unit || 'N/A'}`, 20, 35);
    doc.text(`Date: ${this.formatDate(session.date)}`, 140, 35);
    doc.text(`Total Marines: ${session.marines.length}`, 20, 43);

    // Summary Table Header
    let yPos = 55;
    doc.setFillColor(139, 0, 0); // Marine Corps scarlet
    doc.setTextColor(255, 255, 255);
    doc.rect(15, yPos, 180, 10, 'F');

    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Rank', 20, yPos + 7);
    doc.text('Name', 40, yPos + 7);
    doc.text('Score', 130, yPos + 7);
    doc.text('Class', 155, yPos + 7);
    doc.text('Grade', 180, yPos + 7);

    // Reset text color
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    // Sort marines by score (highest first)
    const sortedMarines = [...session.marines].sort((a, b) =>
      (b.results?.total || 0) - (a.results?.total || 0)
    );

    // Marines data rows
    sortedMarines.forEach((marine, index) => {
      yPos += 10;

      // Alternate row colors
      if (index % 2 === 0) {
        doc.setFillColor(249, 250, 251);
        doc.rect(15, yPos, 180, 10, 'F');
      }

      doc.text(marine.rank || '', 20, yPos + 7);
      doc.text(this.truncate(marine.name || '', 30), 40, yPos + 7);
      doc.text(String(marine.results?.total || 0), 130, yPos + 7);
      doc.text(marine.results?.classification || '', 155, yPos + 7);
      doc.text(marine.results?.grade || '', 180, yPos + 7);

      // Check if we need a new page
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
    });

    // Statistics
    yPos += 20;
    const stats = this.calculateStats(session.marines);

    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('SESSION STATISTICS', 20, yPos);

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    yPos += 10;
    doc.text(`Average Score: ${stats.avgScore}`, 20, yPos);
    doc.text(`Highest Score: ${stats.maxScore}`, 80, yPos);
    doc.text(`Lowest Score: ${stats.minScore}`, 140, yPos);

    yPos += 8;
    doc.text(`1st Class: ${stats.firstClass}`, 20, yPos);
    doc.text(`2nd Class: ${stats.secondClass}`, 60, yPos);
    doc.text(`3rd Class: ${stats.thirdClass}`, 100, yPos);
    doc.text(`Fail: ${stats.fail}`, 140, yPos);

    yPos += 8;
    doc.text(`Pass Rate: ${stats.passRate}%`, 20, yPos);

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(128);
    doc.text('Generated by PFT/CFT Proctor App - USMC Tools Suite', 105, 280, { align: 'center' });

    return doc;
  },

  /**
   * Calculate session statistics
   */
  calculateStats(marines) {
    if (!marines || marines.length === 0) {
      return {
        avgScore: 0, maxScore: 0, minScore: 0,
        firstClass: 0, secondClass: 0, thirdClass: 0, fail: 0, passRate: 0
      };
    }

    const scores = marines.map(m => m.results?.total || 0);
    const classifications = marines.map(m => m.results?.classification || 'Fail');

    const sum = scores.reduce((a, b) => a + b, 0);
    const firstClass = classifications.filter(c => c === '1st Class').length;
    const secondClass = classifications.filter(c => c === '2nd Class').length;
    const thirdClass = classifications.filter(c => c === '3rd Class').length;
    const fail = classifications.filter(c => c === 'Fail').length;

    return {
      avgScore: Math.round(sum / marines.length),
      maxScore: Math.max(...scores),
      minScore: Math.min(...scores),
      firstClass,
      secondClass,
      thirdClass,
      fail,
      passRate: Math.round(((marines.length - fail) / marines.length) * 100)
    };
  },

  /**
   * Save PDF
   */
  savePDF(doc, filename) {
    doc.save(filename);
  },

  /**
   * Open PDF in new tab for printing
   */
  printPDF(doc) {
    const blob = doc.output('blob');
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  },

  /**
   * Format date for display
   */
  formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const day = String(date.getDate()).padStart(2, '0');
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    return `${day} ${month} ${year}`;
  },

  /**
   * Truncate string
   */
  truncate(str, maxLength) {
    if (str.length <= maxLength) return str;
    return str.substring(0, maxLength - 3) + '...';
  }
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = PDFGenerator;
}
